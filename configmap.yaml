apiVersion: v1
kind: ConfigMap
metadata:
  name: logging-fluentd
  namespace: logging
data:
  fluent.conf: >
    # This file is the fluentd configuration entrypoint. Edit with care.


    @include configs.d/openshift/system.conf


    # In each section below, pre- and post- includes don't include anything
    initially;

    # they exist to enable future additions to openshift conf as needed.


    ## sources

    ## ordered so that syslog always runs last...

    @include configs.d/openshift/input-pre-*.conf

    @include configs.d/dynamic/input-docker-*.conf

    @include configs.d/dynamic/input-syslog-*.conf

    @include configs.d/openshift/input-post-*.conf

    ##


    <label @INGRESS>

    ## filters
      @include configs.d/openshift/filter-pre-*.conf
      @include configs.d/openshift/filter-retag-journal.conf
      @include configs.d/openshift/filter-k8s-meta.conf
      @include configs.d/openshift/filter-kibana-transform.conf
      @include configs.d/openshift/filter-k8s-flatten-hash.conf
      @include configs.d/openshift/filter-k8s-record-transform.conf
      @include configs.d/openshift/filter-syslog-record-transform.conf
      @include configs.d/openshift/filter-viaq-data-model.conf
      @include configs.d/openshift/filter-post-*.conf
    ##


    ## matches
      @include configs.d/openshift/output-pre-*.conf
      @include configs.d/openshift/output-operations.conf
      @include configs.d/user/splunk.conf
      @include configs.d/openshift/output-applications.conf
      # no post - applications.conf matches everything left
    ##

    </label>
  secure-forward.conf: |
  #Nothing here to see!
  splunk.conf: |
    <filter kubernetes.**>
      @type record_modifier
      enable_ruby yes
      auto_typecast yes
      <record>
        kubernetes_namespace_name ${record["kubernetes"]["namespace_name"].nil? ? 'devnull' : record["kubernetes"]["namespace_name"]}
        forwarded_by "#{ENV['HOSTNAME']}"
        source_component "OCP"
      </record>
    </filter>

    #Run filter on kube messages
    <filter kubernetes.**>
      @type grep
      #Always filter out the restricted namespaces
      exclude1 kubernetes_namespace_name (devnull|logging|default|openshift|openshift-infra|management-infra|kube-system|prometheus)
    </filter>

    <match kubernetes.**>
      @type splunk_ex
      host mysplunkserver
      port 9997
      output_format json
    </match>

    <match **>
      @type null
    </match>

  throttle-config.yaml: |
    # Logging example fluentd throttling config file

    #example-project:
    #  read_lines_limit: 10
    #
    #.operations:
    #  read_lines_limit: 100
